<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Reverb</title>
<script type="module" src="load.js"></script>
</head>
<body>

<div id="parameter">
<label><select id="property">
<option value="count">count</option>
<option value="q">q</option>
<option value="frequencies">frequencies</option>
</select></label>

<label>value: <input type="number" id="value"></label>
<button id="set">Set</button>

<br><label>min delay: <input type="number" id="min-delay" value="0.02"></label>
<label>max delay: <input type="number" id="max-delay" value="1.5"></label>

<br><label>min gain: <input type="number" id="min-gain" value="0.3"></label>
<label>max gain: <input type="number" id="max-gain" value="0.85"></label>

<label>tap count: <input type="number" id="tap-count" value="10"></label>
<label>Feedback network: <input type="checkbox" id="feedbackNetwork"></label>
</div>


<audio-app label="Reverb" hide-on-bypass> 
<audio-series>
<audio-parallel>
<audio-pulse label="impulse generator" width="20"></audio-pulse>
<audio-player label="player" src="default{./t.opus}" play="shortcut{control x}"></audio-player>
</audio-parallel>

<audio-parallel id="bands">
<audio-series>
<audio-delay></audio-delay>
<audio-filter-bank frequency="32" q="1" hide="mix type gain detune" count="50" type="allpass"></audio-filter-bank>
</audio-series>

<audio-series>
<audio-delay></audio-delay>
<audio-filter-bank  frequency="32" q="1" hide="mix type gain detune" count="50" type="allpass"></audio-filter-bank>
</audio-series>

<audio-series>
<audio-delay></audio-delay>
<audio-filter-bank  frequency="32" q="1" hide="mix type gain detune" count="50" type="allpass"></audio-filter-bank>
</audio-series>

<audio-series>
<audio-delay></audio-delay>
<audio-filter-bank  frequency="32" q="1" hide="mix type gain detune" count="50" type="allpass"></audio-filter-bank>
</audio-series>

<audio-series>
<audio-delay></audio-delay>
<audio-filter-bank  frequency="32" q="1" hide="mix type gain detune" count="50" type="allpass"></audio-filter-bank>
</audio-series>

<audio-series>
<audio-delay></audio-delay>
<audio-filter-bank  frequency="32" q="1" hide="mix type gain detune" count="50" type="allpass"></audio-filter-bank>
</audio-series>

<audio-series>
<audio-delay></audio-delay>
<audio-filter-bank  frequency="32" q="1" hide="mix type gain detune" count="50" type="allpass"></audio-filter-bank>
</audio-series>

<audio-series>
<audio-delay></audio-delay>
<audio-filter-bank  frequency="32" q="1" hide="mix type gain detune" count="50" type="allpass"></audio-filter-bank>
</audio-series>

<audio-series>
<audio-delay></audio-delay>
<audio-filter-bank  frequency="32" q="1" hide="mix type gain detune" count="50" type="allpass"></audio-filter-bank>
</audio-series>

<audio-series>
<audio-delay></audio-delay>
<audio-filter-bank  frequency="32" q="1" hide="mix type gain detune" count="50" type="allpass"></audio-filter-bank>
</audio-series>
</audio-parallel>

<audio-gain label="volume" gain="3" hide="mix bypass"></audio-gain>
<audio-destination label="speakers"></audio-destination>
</audio-series>
</audio-app>

<script src="statistics/simple-statistics.min.js"></script>
<script type="module">
import * as audio from "./audio.js";
import {primes, integers} from "./primes.js";
import {$, $$, _valueOf} from "./utils.js";
 const frequencies = [32, 64, 128, 256, 512,
1000, 2000, 4000, 8000, 16000];


$("audio-app").addEventListener("load", e => e.target.statusMessage("audio app loaded."));
console.debug("reverb init...:");

setTimeout(() => {
$$("#bands audio-series").forEach((s, i) => {
console.debug(`init band ${i}:`);
const delay = $("audio-delay", s);
const fb = $("audio-filter-bank", s);
delay.delay = r(0.001, 0.009);
fb.frequency = frequencies[i];
console.debug(`band ${i}: `, delay, fb);
//debugger;
}); // forEach band
 
$("#parameter #set").addEventListener("click", () => {
const property = $("#parameter #property").value;
const value = $("#parameter #value").value;
//alert(`${property} = ${value}`);
$$("audio-filter-bank").forEach(fb => fb[property] = value);
});

function setFrequencies () {

} // setFrequencies

$("#feedbackNetwork").addEventListener("change", e => {
if (e.target.checked) {
feedback();
} else {
destroyFeedbackNetwork();
} // if
}); // #feedbackNetwork

}, 300); // ready timeout


 
function feedback() {
const tapCount = 10;
const fb = $("audio-filter-bank").filters.length;

if (fb.length < tapCount) {
alert(`need at least ${tapCount} filters`);
return;
} // if

Array.from($$("audio-filter-bank")).forEach(fb => createFeedbackNetwork(
fb, _valueOf("#tap-count"),
_valueOf("#min-delay"), _valueOf("#max-delay"),
_valueOf("#min-gain"), _valueOf("#max-gain")
) // createFeedbackNetwork
); // forEach
} // feedback

function createFeedbackNetwork(fb, count, minDelay, maxDelay, minGain, maxGain) {
const filters = fb.filters;
const gainAdjust = audio.context.createGain();
const step = Math.floor(filters.length / count);
const network = [];
gainAdjust.gain.value = 1/count;

for (let i=0; i<filters.length; i += step) {
const f = filters[i];
const node = {};
node.filter = f;
node.delay = audio.context.createDelay();
node.gain = audio.context.createGain();
node.pan = audio.context.createStereoPanner();

node.delay.delayTime.value = r(minDelay, maxDelay);
node.gain.gain.value = r(minGain, maxGain);
node.pan.pan.value = r(-1,1);
 
node.filter.connect(node.delay).connect(node.gain).connect(node.pan).connect(gainAdjust);
network.push(node);
} // for

gainAdjust.connect(fb.input);
fb._fbn = network;
fb._fbnGainAdjust = gainAdjust;
} // createFeedbackNetwork

function destroyFeedbackNetwork () {
$$("audio-filter-bank").forEach(fb => {
if (fb._fbnGainAdjust) {
fb._fbnGainAdjust.disconnect(fb.input);
fb._fbnGainAdjust = null;
} // if

if (fb._fbn) {
fb._fbn.forEach(node => node.filter.disconnect(node.delay));
fb._fbn = null;
} // if
}); // forEach
} // destroyFeedbackNetwork


function  scale (x, in1,in2, out1,out2) {
in1 = Math.min(in1,in2);
in2 = Math.max(in1,in2);
out1 = Math.min(out1,out2);
out2 = Math.max(out1,out2);
const f = Math.abs(out1-out2) / Math.abs(in1-in2);

return f* Math.abs(x-in1) + out1;
} // scale

function r(a=0, b=1) {return scale(Math.random(), 0,1, a,b);}


</script>

</body>
</html>
